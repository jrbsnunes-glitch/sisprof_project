{% extends 'os_app/base.html' %}

{% block title %}{{ usuario_detalhe.username }} - Detalhes{% endblock %}
{% block page_title %}Detalhes do Usuário{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Coluna Esquerda - Foto e Info Básica -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    {% if perfil.foto %}
                        <img src="{{ perfil.foto.url }}" alt="{{ usuario_detalhe.username }}" 
                             class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 150px; height: 150px; font-size: 3rem; font-weight: bold;">
                            {{ usuario_detalhe.username|slice:":1"|upper }}
                        </div>
                    {% endif %}
                    
                    <h4 class="mb-1">{{ usuario_detalhe.get_full_name|default:usuario_detalhe.username }}</h4>
                    <p class="text-muted mb-1">@{{ usuario_detalhe.username }}</p>
                    <p class="text-muted mb-3">{{ perfil.get_tipo_usuario_display }}</p>
                    
                    <div class="d-flex justify-content-center gap-2 mb-3">
                        {% if usuario_detalhe.is_active %}
                            <span class="badge bg-success">Ativo</span>
                        {% else %}
                            <span class="badge bg-secondary">Inativo</span>
                        {% endif %}
                        
                        {% if usuario_detalhe.is_superuser %}
                            <span class="badge bg-danger">Superusuário</span>
                        {% elif usuario_detalhe.is_staff %}
                            <span class="badge bg-warning">Admin</span>
                        {% endif %}
                    </div>

                    {% if request.user.is_staff or request.user == usuario_detalhe %}
                    <div class="d-grid gap-2">
                        <a href="{% url 'os_app:editar_usuario' usuario_detalhe.id %}" class="btn btn-primary">
                            <i class="bi bi-pencil me-1"></i> Editar Perfil
                        </a>
                        <a href="{% url 'os_app:alterar_senha' usuario_detalhe.id %}" class="btn btn-outline-secondary">
                            <i class="bi bi-key me-1"></i> Alterar Senha
                        </a>
                        <a href="{% url 'os_app:lista_usuarios' %}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-1"></i> Voltar
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Informações de Contato -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-envelope me-2"></i>Contato</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block">Email</small>
                        <strong>{{ usuario_detalhe.email|default:"-" }}</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Telefone</small>
                        <strong>{{ perfil.telefone|default:"-" }}</strong>
                    </div>
                    <div class="mb-0">
                        <small class="text-muted d-block">Celular</small>
                        <strong>{{ perfil.celular|default:"-" }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna Direita - Detalhes Completos -->
        <div class="col-lg-8">
            <!-- Informações Profissionais -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-briefcase me-2"></i>Informações Profissionais</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block">Tipo de Usuário</small>
                            <strong>{{ perfil.get_tipo_usuario_display }}</strong>
                        </div>
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block">Cargo/Função</small>
                            <strong>{{ perfil.cargo_funcao|default:"-" }}</strong>
                        </div>
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block">Departamento</small>
                            <strong>{{ perfil.departamento|default:"-" }}</strong>
                        </div>
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block">Escola Vinculada</small>
                            <strong>{{ perfil.escola_vinculada|default:"-" }}</strong>
                        </div>
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block">Núcleo Vinculado</small>
                            <strong>{{ perfil.nucleo_vinculado|default:"-" }}</strong>
                        </div>
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block">Data de Cadastro</small>
                            <strong>{{ usuario_detalhe.date_joined|date:"d/m/Y H:i" }}</strong>
                        </div>
                    </div>

                    {% if perfil.observacoes %}
                    <div class="mt-3">
                        <small class="text-muted d-block">Observações</small>
                        <p class="mb-0">{{ perfil.observacoes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Permissões -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>Permissões</h5>
                </div>
                <div class="card-body">
                    <!-- Permissões de Professores -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-person-badge me-2"></i>Professores
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_criar_professor %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Criar Professores
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_editar_professor %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Editar Professores
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_excluir_professor %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Excluir Professores
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Permissões de Escolas Núcleo -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-building me-2"></i>Escolas Núcleo
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_criar_escola_nucleo %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Criar Núcleos
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_editar_escola_nucleo %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Editar Núcleos
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_excluir_escola_nucleo %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Excluir Núcleos
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Permissões de Escolas Dependentes -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-buildings me-2"></i>Escolas Dependentes
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_criar_escola_dependente %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Criar Escolas
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_editar_escola_dependente %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Editar Escolas
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_excluir_escola_dependente %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Excluir Escolas
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Permissões Gerais -->
                    <div class="mb-0">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-gear me-2"></i>Permissões Gerais
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_gerar_relatorios %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Gerar Relatórios
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if perfil.pode_exportar_dados %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Pode Exportar Dados
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <i class="bi bi-{% if usuario_detalhe.is_staff %}check-circle text-success{% else %}x-circle text-danger{% endif %} me-2"></i>
                                    Acesso ao Admin
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Últimas Ações -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Últimas Ações</h5>
                </div>
                <div class="card-body p-0">
                    {% if ultimas_acoes %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Ação</th>
                                    <th>Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in ultimas_acoes %}
                                <tr>
                                    <td class="text-nowrap">{{ log.data_hora|date:"d/m/Y H:i" }}</td>
                                    <td><span class="badge bg-info">{{ log.get_acao_display }}</span></td>
                                    <td>{{ log.descricao|truncatewords:10 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <p class="text-muted mb-0">Nenhuma ação registrada</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}