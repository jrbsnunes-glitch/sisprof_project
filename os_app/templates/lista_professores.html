{% extends "os_app/base.html" %}

{% block title %}Lista de Professores - SISPROF{% endblock %}
{% block page_title %}Lista de Professores{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">Professores Cadastrados</h4>
                <p class="text-muted mb-0">
                    <i class="bi bi-people-fill"></i> Total: <strong>{{ professores|length }}</strong> professor{{ professores|length|pluralize:"es" }}
                </p>
            </div>
            <a href="{% url 'os_app:novo_professor' %}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Novo Professor
            </a>
        </div>
    </div>
</div>

<!-- Filtros e Busca -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nome, CPF, matrícula...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterEscola">
                    <option value="">Todas as Escolas</option>
                    <option value="com_escola">Com Escola</option>
                    <option value="sem_escola">Sem Escola</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterArea">
                    <option value="">Todas as Áreas</option>
                    {% for value, label in area_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                    <i class="bi bi-x-circle"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Professores -->
<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="professoresTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>Professor</th>
                        <th>CPF</th>
                        <th>Matrícula</th>
                        <th>Escola</th>
                        <th>Área de Atuação</th>
                        <th>Localização</th>
                        <th class="text-center" style="width: 150px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for professor in professores %}
                    <tr data-nome="{{ professor.nome|lower }}" 
                        data-cpf="{{ professor.cpf }}" 
                        data-matricula="{{ professor.matricula|default:'' }}"
                        data-area="{{ professor.area_atuacao }}"
                        data-escola="{% if professor.escola or professor.escola_nucleo %}com_escola{% else %}sem_escola{% endif %}">
                        <td>
                            <input type="checkbox" class="form-check-input row-checkbox">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle bg-primary text-white me-2">
                                    {{ professor.nome|slice:":1"|upper }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ professor.nome|truncatechars:40 }}</div>
                                    <small class="text-muted">
                                        <i class="bi bi-envelope"></i> {{ professor.email|truncatechars:30 }}
                                    </small>
                                </div>
                            </div>
                        </td>
                        <td class="nowrap">
                            <small class="font-monospace">{{ professor.cpf_formatado }}</small>
                        </td>
                        <td>
                            {% if professor.matricula %}
                                <span class="badge bg-secondary">{{ professor.matricula }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
    {% if professor.escola %}
        <div>
            <i class="bi bi-building text-success"></i>
            <strong>{{ professor.escola.nome }}</strong>
        </div>
        {% if professor.escola.nucleo %}
            <small class="text-muted">
                <i class="bi bi-buildings"></i> {{ professor.escola.nucleo.nome }}
            </small>
        {% endif %}
    {% elif professor.escola_nucleo %}
        <div>
            <i class="bi bi-buildings text-primary"></i>
            <strong>{{ professor.escola_nucleo.nome }}</strong>
        </div>
        <span class="badge bg-primary">Núcleo</span>
    {% else %}
        <span class="text-muted">-</span>
    {% endif %}
</td>
                        <td>
                            {% if professor.area_atuacao %}
                                <span class="badge bg-info text-dark">
                                    {{ professor.get_area_atuacao_display|truncatechars:20 }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <i class="bi bi-geo-alt"></i>
                                <small>{{ professor.cidade }}/{{ professor.estado }}</small>
                            </div>
                            {% if professor.bairro %}
                                <small class="text-muted">{{ professor.bairro.nome }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'os_app:detalhe_professor' professor.id %}" 
                                   class="btn btn-outline-primary" 
                                   title="Ver detalhes">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'os_app:editar_professor' professor.id %}" 
                                   class="btn btn-outline-warning" 
                                   title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button class="btn btn-outline-danger" 
                                        onclick="confirmarExclusao({{ professor.id }}, '{{ professor.nome }}')"
                                        title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3">Nenhum professor cadastrado.</p>
                                <a href="{% url 'os_app:novo_professor' %}" class="btn btn-primary">
                                    <i class="bi bi-person-plus"></i> Cadastrar Primeiro Professor
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% if professores %}
    <div class="card-footer bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">
                    <span id="selectedCount">0</span> selecionado(s)
                </small>
                <button class="btn btn-sm btn-outline-danger ms-2" id="deleteSelectedBtn" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir Selecionados
                </button>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportarExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="imprimirLista()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.table > tbody > tr {
    transition: all 0.2s ease;
}

.table > tbody > tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

.font-monospace {
    font-family: 'Courier New', monospace;
}
</style>

<script>
// Busca em tempo real
document.getElementById('searchInput').addEventListener('input', function() {
    filtrarTabela();
});

// Filtros
document.getElementById('filterEscola').addEventListener('change', function() {
    filtrarTabela();
});

document.getElementById('filterArea').addEventListener('change', function() {
    filtrarTabela();
});

function filtrarTabela() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filterEscola = document.getElementById('filterEscola').value;
    const filterArea = document.getElementById('filterArea').value;
    
    const rows = document.querySelectorAll('#professoresTable tbody tr[data-nome]');
    
    rows.forEach(row => {
        const nome = row.getAttribute('data-nome');
        const cpf = row.getAttribute('data-cpf');
        const matricula = row.getAttribute('data-matricula');
        const escola = row.getAttribute('data-escola');
        const area = row.getAttribute('data-area');
        
        const matchSearch = nome.includes(searchTerm) || 
                          cpf.includes(searchTerm) || 
                          matricula.includes(searchTerm);
        
        const matchEscola = !filterEscola || escola === filterEscola;
        const matchArea = !filterArea || area === filterArea;
        
        if (matchSearch && matchEscola && matchArea) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function limparFiltros() {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterEscola').value = '';
    document.getElementById('filterArea').value = '';
    filtrarTabela();
}

// Selecionar todos
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    atualizarContador();
});

// Atualizar contador de selecionados
document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', atualizarContador);
});

function atualizarContador() {
    const selected = document.querySelectorAll('.row-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selected;
    document.getElementById('deleteSelectedBtn').style.display = selected > 0 ? 'inline-block' : 'none';
}

// Confirmar exclusão
function confirmarExclusao(id, nome) {
    if (confirm(`Tem certeza que deseja excluir o professor "${nome}"?`)) {
        // Implementar exclusão via AJAX ou form
        alert('Funcionalidade de exclusão a ser implementada!');
    }
}

// Exportar Excel
function exportarExcel() {
    alert('Funcionalidade de exportação a ser implementada!');
}

// Imprimir
function imprimirLista() {
    window.print();
}

// Inicializar contador
atualizarContador();
</script>

{% endblock %}